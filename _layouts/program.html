{% include partials/header.html %}
  <h1 class="display-5 mb-4">
    {%- if page.title -%}
      {{- page.title -}}
    {%- else -%}
      {{- site.data.lang[site.conference.lang].program.title | default: "Program" -}}
    {%- endif -%}
  </h1>

  {{ content }}

  <!-- Create a unified table for the talks -->
  <div class="table-responsive">
    <table class="table table-bordered mx-auto">
      <thead>
        <tr>
          <th scope="col" class="text-center">Time</th>
          <!-- Create table headers for rooms across all days -->
          {%- for d in site.data.program.days -%}
            {%- for r in d.rooms -%}
              {%- assign room = site.rooms | where: 'name', r.name | first %}
              <th scope="col" class="text-center">
                {%- if room.hide or site.conference.location.hide -%}
                  {{- room.name -}}
                {%- else -%}
                  <a class="text-reset" href="{{ room.url | prepend: site.baseurl }}">
                    {{- room.name -}} <br> ({{ d.date | date: "%A" }})
                  </a>
                {%- endif -%}
              </th>
            {%- endfor %}
          {%- endfor %}
        </tr>
      </thead>

      <tbody>
        {%- assign all_time_slots = "" -%}

        <!-- Step 1: Collect all time slots across days and rooms -->
        {%- for d in site.data.program.days -%}
          {%- for r in d.rooms -%}
            {%- for t in r.talks -%}
              {%- assign talk = site.talks | where: 'name', t.name | first %}
              {%- include partials/get_talk_time.html -%}

              <!-- Convert hours and minutes to "HH:MM" padded format -->
              {%- assign padded_hour = talk_start_hour | prepend: "0" | slice: -2 -%}
              {%- assign padded_minute = talk_start_min | prepend: "0" | slice: -2 -%}
              {%- assign talk_time = padded_hour | append: ":" | append: padded_minute %}

              <!-- Append to all_time_slots -->
              {%- assign all_time_slots = all_time_slots | append: talk_time | append: "," -%}
            {%- endfor %}
          {%- endfor %}
        {%- endfor %}

        <!-- Step 2: Convert times to total minutes and store them -->
        {%- assign time_slots = all_time_slots | split: "," | uniq -%}

        <!-- Step 3: Create an array of time slots sorted by total minutes since midnight -->
        {%- assign time_slots_sorted = "" -%}
        {%- for time in time_slots %}
          {%- if time != "" %}
            {%- assign time_parts = time | split: ":" -%}
            {%- assign hour = time_parts[0] | plus: 0 -%}  <!-- Convert to number -->
            {%- assign minute = time_parts[1] | plus: 0 -%}  <!-- Convert to number -->

            <!-- Calculate total minutes since midnight -->
            {%- assign total_minutes = hour | times: 60 | plus: minute -%}

            <!-- Store the original time and its total minutes representation -->
            {%- assign time_slots_sorted = time_slots_sorted | append: total_minutes | append: ":" | append: time | append: "," -%}
          {%- endif %}
        {%- endfor %}

        <!-- Step 4: Sort the times based on total minutes -->
        {%- assign sorted_time_slots = time_slots_sorted | split: "," | sort %}

        <!-- Step 5: Render the sorted times -->
        <!-- Loop through sorted times and render rows -->
        {%- for item in sorted_time_slots %}
          {%- assign item_parts = item | split: ":" -%}
          {%- assign total_minutes = item_parts[0] -%}
          {%- assign time = item_parts[1] -%}

          <tr>
            <td class="text-center">{{ time }}</td>

            {%- for d in site.data.program.days -%}
              {%- for r in d.rooms -%}
                {%- assign room = site.rooms | where: 'name', r.name | first %}

                <!-- Check if there is a talk at this time in this room -->
                {%- assign talk_found = false -%}
                {%- for t in r.talks -%}
                  {%- assign talk = site.talks | where: 'name', t.name | first %}
                  {%- include partials/get_talk_time.html -%}

                  <!-- Pad hours and minutes for comparison -->
                  {%- assign padded_hour = talk_start_hour | prepend: "0" | slice: -2 -%}
                  {%- assign padded_minute = talk_start_min | prepend: "0" | slice: -2 -%}
                  {%- assign talk_time = padded_hour | append: ":" | append: padded_minute -%}

                  {%- if talk_time == time %}
                    <!-- Render the talk in the corresponding cell -->
                    <td class="alert alert-{{ main_cat_color }} shadow-sm overflow-hidden">
                      <p class="mb-2">
                        {%- include partials/show_talk.html %}
                      </p>
                      <p class="font-weight-light mb-2">
                        {%- include partials/list_speakers.html %}
                      </p>
                      <p class="mb-1">
                        {%- include partials/list_sub_categories.html %}
                      </p>
                    </td>
                    {%- assign talk_found = true -%}
                    {%- break -%}
                  {%- endif %}
                {%- endfor %}

                <!-- If no talk is found, render an empty cell -->
                {%- if talk_found == false %}
                  <td></td>
                {%- endif %}
              {%- endfor %}
            {%- endfor %}
          </tr>
        {%- endfor %}
      </tbody>
    </table>
  </div>

  {%- if site.conference.talks.main_categories %}
    <h5 class="mt-4">{{ site.data.lang[site.conference.lang].program.legend | default: "BackToTheFuture" }}</h5>
      {%- for main_cat in site.conference.talks.main_categories %}
        <div class="d-block d-sm-inline-block m-1 p-1 pl-2 pr-2 border-soft-{{ main_cat.color }} bg-soft-{{ main_cat.color }} font-weight-normal">
          {{- main_cat.name -}}
        </div>
      {%- endfor %}
  {%- endif %}

{% include partials/footer.html %}
